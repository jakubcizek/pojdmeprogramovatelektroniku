<!DOCTYPE html>
<html lang="cs">
<head>
    <title>Smart Home ≈Ωiv√°k</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sofia+Sans+Semi+Condensed&display=swap" rel="stylesheet">
    <style>
        /* CSS styl str√°nky
         * Bez okraje, bez posuvn√≠k≈Ø
         * S rozlo≈æen√≠m tabulky
        */
        html, body{
            font-family: "Sofia Sans Semi Condensed", sans-serif;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: table;
            overflow: hidden;
            cursor: pointer;
        }
        /* CSS styl hlavn√≠ho okna s v√Ωsledkem
         * Pru≈æn√° velikost p√≠sma podle v√Ω≈°ky okna,
         * zobrazen√≠ jako tabulkov√° bu≈àka s vycentrovan√Ωm obsahem
        */
        #outputbox{
            font-size: 5vh;
            display: table-cell;
            text-align: center;
            vertical-align: middle;
            padding: 50px 50px;
        }
        /* CSS styl pomocn√©ho okna v z√°pat√≠
         * Druh√Ω ≈ô√°dek tabulky, funkce patiƒçky str√°nky
        */
        #infobox{
            color: #bbbbbb;
            font-size: 3vh;
            display: table-row;
            text-align: center;
        }
        /* T≈ô√≠da stylu error pro obarven√≠ chyby do ruda */
        .error{
            color:coral;
        }


    </style>
    <script>
        let smarthome_url = "http://127.0.0.1/smarthome/speech/" // HTTP cesta k webov√©mu serveru
        let stt; // Promƒõnn√° objektu p≈ôevodu hlasu na text (Speech To Text)
        let tokens_input_total = 0; 
        let tokens_output_total = 0; 
        let tokens_input_price_total = 0; 
        let tokens_output_price_total = 0; 

        // Po kliknuti my≈°√≠ na str√°nku zavolej funkci listening
        document.onclick = (event) => listening();

        // Po stisku kl√°vesy zavolej funkci listening
        document.onkeydown = (event) => {
           listening();
        }

        // Po kompletn√≠m naƒçten√≠ str√°nky zpracuj tuto anonymn√≠ funkci
        window.onload = (event) => {
            document.title = "Smart Home ≈Ωiv√°k";
            outputBox("Klepni a ≈ôekni povel"); // Napi≈° hl√°≈°ku do okna
            console.log("Komand√©re, ok√©nko prohl√≠≈æeƒçe je p≈ôipraveno k hr√°tk√°m"); // Vypi≈° do konzole prohl√≠≈æeƒçe uv√≠t√°n√≠
            stt = new webkitSpeechRecognition(); // Nastartuj technologii Web Speech API v prohl√≠≈æeƒçi Chrome
            stt.continuous = false; // Nechceme z√≠sk√°vat pr≈Øbƒõ≈æn√© v√Ωsledky, ale a≈æ celou vƒõtu
            stt.lang = "cs-CZ"; // Chceme na text p≈ôev√°dƒõt hlas v ƒçe≈°tinƒõ
            stt.interimResults = false; // Nechceme dost√°vat (rychlej≈°√≠) p≈ôedbƒõ≈æn√© v√Ωsledky, ale a≈æ fin√°ln√≠ a kvalitn√≠

            // Jakmile p≈ôevod ≈ôeƒçi na text usly≈°√≠ del≈°√≠ ticho, p≈ôestane poslouchat, zpracuje zvuk a zavol√° tuto anonymn√≠ funkci  
            stt.onresult = (event) => {
                if(event.results.length > 0){ // Pokud jsme z√≠skali alespo≈à 1 v√Ωsledek
                    let text = event.results[0][0].transcript; // Ulo≈æ do pomocn√© promƒõnn√© prvn√≠ v√Ωsledek z pole p≈ôepis≈Ø
                    console.log("========================================"); // Vypi≈° do konzole pro kontrolu, co prohl√≠≈æeƒç usly≈°el
                    console.log("Hlas: ‚Äû" + text + "‚Äú");
                    outputBox("Zpracov√°v√°m povel..."); // Napi≈° hl√°≈°ku do okna
                    smartHome(text.toLowerCase()); // Po≈°li text k s√©mantick√© anal√Ωze
                }
                // Pokud ≈æ√°dn√Ω v√Ωsledek nem√°me,
                // resetuj pohled a do patiƒçky nai≈° d≈Øvod
                else{
                    outputBox("Klepni a nƒõco ≈ôekni...");
                    infoBox("≈Ω√°dn√© mluven√© slovo");
                }
            }
            stt.onspeechend = () => stt.stop(); // Na konci detekce mluven√©ho slova ukonƒçi poslech
            // V p≈ô√≠padƒõ chyby p≈ôevodu Speech To Text
            stt.onerror = (event) => {
                console.log(event.error);
                outputBox("Klepni a nƒõco ≈ôekni...");
                infoBox("Chyba anal√Ωzy hlasu: <span class='error'>" + event.error + '</spann>');
            }
            // V p≈ô√≠padƒõ, ≈æe Speech To Text nedok√°≈æe naj√≠t ≈æ√°dn√© mluven√© slovo
            stt.onnomatch = (event) => {
                outputBox("Klepni a nƒõco ≈ôekni...");
                infoBox("Nerozpoznal jsem ≈æ√°dn√© mluven√© slovo");
            }
        }

        // Funkce listening spust√≠ p≈ôevod hlasu na text
        function listening(){
            console.log("üé§ Poslouch√°m...");
            window.speechSynthesis.cancel(); // Pokud hlasov√Ω syntetiz√°tor pr√°vƒõ mluv√≠, ukonƒç√≠ ho
            outputBox("Poslouch√°m...");// Do textov√©ho okna napi≈° informaƒçn√≠ zpr√°viƒçku
            stt.start(); // Koneƒçnƒõ aktivuj poslech
        }

        // Pomocn√° funkce pro zobrazen√≠ textu v patiƒçce
        function infoBox(text){
            document.querySelector("#infobox").innerHTML = text;
        }

        // Pomocn√° funkce pro zobrazen√≠ hlavn√≠ho textu na st≈ôedu obrazovky
        function outputBox(text){
            document.querySelector("#outputbox").innerHTML = text;
        }

        // Hlavn√≠ funkce pro anal√Ωzu textu, kter√Ω jsme z√≠skali z STT (Speech-To-Text) 
        // Na n√°≈° server pos√≠l√°m HTTP POST s tƒõlem fe form√°tu JSON:
        // {"text": "p≈ôeveden√Ω text z hlasu"}
        function smartHome(text){
            console.log("ü§ñ Povel pro server chytr√© dom√°cnosti: '" + text + "'")
            fetch(smarthome_url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({"text": text})
                })
                // ƒåek√°me na odpovƒõƒè ve form√°tu JSON
                .then((odpoved) => odpoved.json())
                .then((json) =>{
                    // Pokud je kl√≠ƒç return pravda
                    if(json.return){
                        // V odpovƒõdi dorazila textov√° hl√°≈°ka (zapnul jsme za≈ô√≠zen√≠ XYZ apod.)
                        // A tak√© statistika se spot≈ôebou token≈Ø a jejich cenou (dle kurzu, viz skript v Pythonu)
                        let text = json.text;
                        let tokens_input = json.tokensInput;
                        let tokens_output = json.tokensOutput;
                        let tokens_input_price = json.tokensInputPrice;
                        let tokens_output_price = json.tokensOutputPrice;
                        tokens_input_total += tokens_input;
                        tokens_output_total += tokens_output;
                        tokens_input_price_total += tokens_input_price;
                        tokens_output_price_total += tokens_output_price;

                        // Textovou hl√°≈°ku vyp√≠≈°eme do hlavn√≠ho okna
                        outputBox(text);

                        // Do patiƒçky vyp√≠≈°eme statistiku spot≈ôebovan√Ωch token≈Ø
                        let total_price = tokens_input_price_total + tokens_output_price_total;
                        let info = "Cena dotazu: <b>" + tokens_input_price.toFixed(6) + " USD</b> (" + tokens_input + " token≈Ø)";
                        info += "<br>Cena odpovƒõdi: <b>" + tokens_output_price.toFixed(6) + " USD</b> (" + tokens_output + " token≈Ø)";
                        info += "<br><br />Celkov√° cena sezen√≠: <b>" + total_price.toFixed(6) + " USD</b> (vstup: " + tokens_input_total + " token≈Ø, v√Ωstup: " + tokens_output_total + " token≈Ø)";
                        infoBox(info);
                    }
                    // Pokud je kl√≠ƒç return nepravda,
                    // vyp√≠≈°eme chybov√© hl√°≈°en√≠
                    else{
                        console.log(json.text);
                        outputBox(json.text);
                        infoBox("Chytr√° dom√°cnost neprovedla ≈æ√°dnou akci");
                    }
                });
        }
    </script>
</head>
<body>
    <!-- HTML prvek DIV s identifik√°torem vysledek. Tady se budou zobrazovat v√Ωsledky -->
    <div id="outputbox">Klepni a na nƒõco se zeptej</div>
    <!-- HTML prvek DIV s identifik√°torem infrormace. Slou≈æ√≠ jako patiƒçka s dodytateƒçn√Ωmi informacemi -->
    <div id="infobox">Hlasov√© ovl√°d√°n√≠ dom√°cnosti s vyu≈æit√≠m AI GPT-3.5</div>
</body>
</html> 
